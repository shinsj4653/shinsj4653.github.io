{"componentChunkName":"component---src-templates-post-template-tsx","path":"/ES_실시간_검색어_순위/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"tableOfContents":"<ul>\n<li>\n<p><a href=\"#logback\">Logback</a></p>\n</li>\n<li>\n<p><a href=\"#logstash---2%EA%B0%9C%EC%9D%98-conf-%ED%8C%8C%EC%9D%BC-%EB%8F%99%EC%8B%9C-%EC%8B%A4%ED%96%89\">Logstash - 2개의 conf 파일 동시 실행</a></p>\n<ul>\n<li><a href=\"#pipelinesyml\">pipelines.yml</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#log-%EC%A0%84%EC%86%A1-%EB%8B%B4%EB%8B%B9-conf-%ED%8C%8C%EC%9D%BC\">Log 전송 담당 conf 파일</a></p>\n</li>\n<li>\n<p><a href=\"#springboot%EC%9D%98-logback-springxml\">SpringBoot의 logback-spring.xml</a></p>\n<ul>\n<li><a href=\"#gradle-%EB%9D%BC%EC%9D%B4%EB%B8%8C%EB%9F%AC%EB%A6%AC-%EC%B6%94%EA%B0%80\">gradle 라이브러리 추가</a></li>\n<li><a href=\"#logback-springxml\">logback-spring.xml</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#bucket-aggregations\">Bucket Aggregations</a></p>\n</li>\n<li>\n<p><a href=\"#high-level-rest-client\">High Level Rest Client</a></p>\n<ul>\n<li><a href=\"#%EA%B3%B5%ED%86%B5-%EC%82%AC%ED%95%AD---elasticutiljava\">공통 사항 - ElasticUtil.java</a></li>\n<li><a href=\"#%EB%A9%94%ED%83%80-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EC%A0%84%EC%B2%B4-%EA%B8%B0%EC%A4%80-%EA%B2%80%EC%83%89-api\">메타 데이터 전체 기준 검색 API</a></li>\n<li><a href=\"#%EC%8B%A4%EC%8B%9C%EA%B0%84-%EA%B2%80%EC%83%89%EC%96%B4-%EC%88%9C%EC%9C%84-api\">실시간 검색어 순위 API</a></li>\n</ul>\n</li>\n</ul>","html":"<p>데이터 포털 SpringBoot 프로젝트에서 메타데이터 검색 API 실행 시, 해당 검색어 로그를 Logstash를 통해 ES로 전송 후, 해당 로그들을 일정 기준으로 집계하여 <code class=\"language-text\">실시간 검색어 순위</code>를 파악하고자 한다.</p>\n<h1 id=\"logback\" style=\"position:relative;\">Logback<a href=\"#logback\" aria-label=\"logback permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>SpringBoot는 기본적으로 `Logback“ 로깅 프레임워크를 사용하여 로그를 기록하는데, 다행히 이를 ES로 전송하는 기능이 있다.</p>\n<p>SpringBoot 프로젝트의 resources 폴더안에 xml 파일을 생성 후, 이 파일 내에서 http 요청의 로그를 전송해준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\">// logback-access-spring.xml\n<span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>configuration</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>springProperty</span> <span class=\"token attr-name\">scope</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>context<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>elasticsearch_uris<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">source</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>spring.elasticsearch.uris<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">defaultValue</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>http://localhost:9200<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>appender</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>ELASTIC<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>com.internetitem.logback.elasticsearch.ElasticsearchAccessAppender<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>url</span><span class=\"token punctuation\">></span></span>http://localhost:9200/_bulk<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>url</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>index</span><span class=\"token punctuation\">></span></span>application-accesslog-%date{yyyy-MM-dd}<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>index</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>headers</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>header</span><span class=\"token punctuation\">></span></span>\n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>name</span><span class=\"token punctuation\">></span></span>Content-Type<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>name</span><span class=\"token punctuation\">></span></span>\n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>value</span><span class=\"token punctuation\">></span></span>application/json<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>value</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>header</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>headers</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>appender</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>appender-ref</span> <span class=\"token attr-name\">ref</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>ELASTIC<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>configuration</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>그러나, ES로 바로 로그를 넘길 시 포맷이 깔끔하게 보내지지 않는 오류가 존재한다.</p>\n<p>이를 해결하기 위해 <code class=\"language-text\">Logstash</code> 를 거친 다음에 ES 로 넘겨줄 예정이다.</p>\n<h1 id=\"logstash---2개의-conf-파일-동시-실행\" style=\"position:relative;\">Logstash - 2개의 conf 파일 동시 실행<a href=\"#logstash---2%EA%B0%9C%EC%9D%98-conf-%ED%8C%8C%EC%9D%BC-%EB%8F%99%EC%8B%9C-%EC%8B%A4%ED%96%89\" aria-label=\"logstash   2개의 conf 파일 동시 실행 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<h2 id=\"pipelinesyml\" style=\"position:relative;\">pipelines.yml<a href=\"#pipelinesyml\" aria-label=\"pipelinesyml permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>DB 에서 pull 해온 테이블을 저장해주는 config와, 검색 로그를 전송해줄 config 파일 2개가 필요해졌다.</p>\n<p>여러 config 파일을 동시에 실행해주려면, logtash의 config 폴더 내의 <code class=\"language-text\">pipelines.yml</code> 을 사용하면 된다.</p>\n<ul>\n<li>Logstash 여러개 실행 - <a href=\"https://m.blog.naver.com/inggi/221816427585\" target=\"_blank\" rel=\"nofollow\">https://m.blog.naver.com/inggi/221816427585</a></li>\n</ul>\n<p>위의 글을 참고하여 다음과 같이 yml 파일을 수정했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># List of pipelines to be loaded by Logstash</span>\n<span class=\"token comment\">#</span>\n<span class=\"token comment\"># This document must be a list of dictionaries/hashes, where the keys/values are pipeline settings.</span>\n<span class=\"token comment\"># Default values for omitted settings are read from the `logstash.yml` file.</span>\n<span class=\"token comment\"># When declaring multiple pipelines, each MUST have its own `pipeline.id`.</span>\n<span class=\"token comment\">#</span>\n<span class=\"token comment\"># Example of two pipelines:</span>\n<span class=\"token comment\">#</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pipeline.id</span><span class=\"token punctuation\">:</span> id_database\n  <span class=\"token key atrule\">pipeline.workers</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">path.config</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"../bin/logstash-database.conf\"</span>\n\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pipeline.id</span><span class=\"token punctuation\">:</span> id_searchlog\n  <span class=\"token key atrule\">pipeline.workers</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">path.config</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"../bin/logstash-searchlog.conf\"</span>\n<span class=\"token comment\">#   pipeline.batch.size: 1</span>\n<span class=\"token comment\">#   config.string: \"input { generator {} } filter { sleep { time => 1 } } output { stdout { codec => dots } }\"</span>\n<span class=\"token comment\"># - pipeline.id: another_test</span>\n<span class=\"token comment\">#   queue.type: persisted</span>\n<span class=\"token comment\">#   path.config: \"/tmp/logstash/*.config\"</span>\n<span class=\"token comment\">#</span></code></pre></div>\n<p>각 conf 파일의 id, workers, 그리고 경로 지정을 마친 후, 다음 명령어로 logstash를 실행해주면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># bin 폴더 내에서</span>\n./logstash.bat</code></pre></div>\n<p>별도의 옵션이 없으면 <code class=\"language-text\">./config/pipelines.yml</code> 을 읽어 실행해준다.</p>\n<h1 id=\"log-전송-담당-conf-파일\" style=\"position:relative;\">Log 전송 담당 conf 파일<a href=\"#log-%EC%A0%84%EC%86%A1-%EB%8B%B4%EB%8B%B9-conf-%ED%8C%8C%EC%9D%BC\" aria-label=\"log 전송 담당 conf 파일 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>DB 테이블 pull 용 conf 는 logstash-database.conf, 로그 담당은 logstash-searchlog.conf 파일로 이름을 지었고, 다음과 같이 구성하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Sample Logstash configuration for creating a simple</span>\n<span class=\"token comment\"># Beats -> Logstash -> Elasticsearch pipeline.</span>\n\ninput <span class=\"token punctuation\">{</span>\n  tcp <span class=\"token punctuation\">{</span>\n    port <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token number\">4560</span>\n    codec <span class=\"token operator\">=</span><span class=\"token operator\">></span> json_lines\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\noutput <span class=\"token punctuation\">{</span>\n  elasticsearch <span class=\"token punctuation\">{</span>\n    hosts <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"http://localhost:9200\"</span><span class=\"token punctuation\">]</span>\n\t    index <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"application-accesslog-%{+YYYY.MM.dd}\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h1 id=\"springboot의-logback-springxml\" style=\"position:relative;\">SpringBoot의 logback-spring.xml<a href=\"#springboot%EC%9D%98-logback-springxml\" aria-label=\"springboot의 logback springxml permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<ul>\n<li>logback-spring.xml : <a href=\"https://ggparkitbank.tistory.com/190\" target=\"_blank\" rel=\"nofollow\">https://ggparkitbank.tistory.com/190</a></li>\n<li>SpringBoot 로그 설정 : <a href=\"https://hello-startup.tistory.com/4\" target=\"_blank\" rel=\"nofollow\">https://hello-startup.tistory.com/4</a></li>\n</ul>\n<h2 id=\"gradle-라이브러리-추가\" style=\"position:relative;\">gradle 라이브러리 추가<a href=\"#gradle-%EB%9D%BC%EC%9D%B4%EB%B8%8C%EB%9F%AC%EB%A6%AC-%EC%B6%94%EA%B0%80\" aria-label=\"gradle 라이브러리 추가 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">// spring boot log to logstash\nimplementation <span class=\"token string\">'net.logstash.logback:logstash-logback-encoder:7.1.1'</span></code></pre></div>\n<h2 id=\"logback-springxml\" style=\"position:relative;\">logback-spring.xml<a href=\"#logback-springxml\" aria-label=\"logback springxml permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><code class=\"language-text\">TcpSocker</code>를 통해 로그를 보내줄 예정이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">&lt;</span>?xml <span class=\"token assign-left variable\">version</span><span class=\"token operator\">=</span><span class=\"token string\">\"1.0\"</span> <span class=\"token assign-left variable\">encoding</span><span class=\"token operator\">=</span><span class=\"token string\">\"UTF-8\"</span>?<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>configuration <span class=\"token assign-left variable\">scan</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token assign-left variable\">scanPeriod</span><span class=\"token operator\">=</span><span class=\"token string\">\"30 seconds\"</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>-- Console --<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>appender <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"CONSOLE\"</span> <span class=\"token assign-left variable\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"ch.qos.logback.core.ConsoleAppender\"</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>encoder<span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span>pattern<span class=\"token operator\">></span>%d<span class=\"token punctuation\">{</span>HH:mm:ss.SSS<span class=\"token punctuation\">}</span> <span class=\"token punctuation\">[</span>%thread<span class=\"token punctuation\">]</span> %-5level %logger<span class=\"token punctuation\">{</span><span class=\"token number\">10</span><span class=\"token punctuation\">}</span> - %msg%n<span class=\"token operator\">&lt;</span>/pattern<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>/encoder<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>/appender<span class=\"token operator\">></span>\n\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>-- Logstash --<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>appender <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"LOGSTASH\"</span> <span class=\"token assign-left variable\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"net.logstash.logback.appender.LogstashTcpSocketAppender\"</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>destination<span class=\"token operator\">></span>localhost:456<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>/destination<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>encoder <span class=\"token assign-left variable\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"net.logstash.logback.encoder.LogstashEncoder\"</span><span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span>timeZone<span class=\"token operator\">></span>GMT+<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>&lt;</span>/timeZone<span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span>timestampPattern<span class=\"token operator\">></span>yyyy-MM-dd<span class=\"token string\">'T'</span>HH:mm:ss<span class=\"token operator\">&lt;</span>/timestampPattern<span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span>fieldNames<span class=\"token operator\">></span>\n                <span class=\"token operator\">&lt;</span>timestamp<span class=\"token operator\">></span>time<span class=\"token operator\">&lt;</span>/timestamp<span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span>/fieldNames<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>/encoder<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>/appender<span class=\"token operator\">></span>\n\n    <span class=\"token operator\">&lt;</span>root <span class=\"token assign-left variable\">level</span><span class=\"token operator\">=</span><span class=\"token string\">\"INFO\"</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>appender-ref <span class=\"token assign-left variable\">ref</span><span class=\"token operator\">=</span><span class=\"token string\">\"CONSOLE\"</span> /<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>appender-ref <span class=\"token assign-left variable\">ref</span><span class=\"token operator\">=</span><span class=\"token string\">\"LOGSTASH\"</span> /<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>/root<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>/configuration<span class=\"token operator\">></span></code></pre></div>\n<p><code class=\"language-text\">destination</code> 에 명시한 logstash의 주소로 input 요청을 보내고, logstash의 <code class=\"language-text\">logstash-searchlog.conf</code> 를 통해 받은 input 요청을 ouput을 통해 명시해준 ES 주소로 보내준다.</p>\n<p>여기서 주의해야할 점은 XML 파일명을 <code class=\"language-text\">logback-spring.xml 로 정확히 설정</code>해줘야 한다는 점이다.</p>\n<blockquote>\n<p>이유 : 자동 구성 기능 활용: Spring Boot는 logback-spring.xml 파일을 자동으로 인식하고 해당 설정을 적용합니다. 이를 통해 사용자는 로깅 설정을 별도로 코드로 지정하지 않아도 됩니다.</p>\n</blockquote>\n<p>그리고, 한국 기준 시간대 범위 값 내의 로그만을 활용하기 위해, <code class=\"language-text\">timeZone 에 GMT+9 옵션</code>을 달아줬다.</p>\n<p><code class=\"language-text\">timestampPattern</code> 옵션을 통해 알아보기 쉬운 형태의 시간 형식으로 출력</p>\n<ul>\n<li>logstash-logback-encoder : <a href=\"https://github.com/logfellow/logstash-logback-encoder?source=post_page-----e62c691128b--------------------------------#registering-additional-providers\" target=\"_blank\" rel=\"nofollow\">https://github.com/logfellow/logstash-logback-encoder?source=post_page-----e62c691128b--------------------------------#registering-additional-providers</a></li>\n</ul>\n<p>해당 깃헙 문서를 통해, <code class=\"language-text\">@timestamp</code> 값을 커스터마이징 해줄 수 있는 <code class=\"language-text\">LogstashEncoder</code> 를 활용하였다.<br>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9b391844dfbf4a550aed8926c740d642/7b4c0/image-22.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAABOUlEQVQoz5WR7YodIQyGvf/LLMvS9uw4OibmOxZn2EOhv/oiYoK8SZ6U1gfgvAZeAwAQAHGHsEOkiFhrqZl7+Lcy03bGy6+jf1b8+IILWVVFt+SWqmXmWotYEHGMgQBjDHefxDSpsKhs34zcPzNX5PudZs5827h7xG1tIroym2kBJEAyD/PQ+3iER5pH5GKWo7az9XZdal7P8zhq6yPMf6sUQhTm9ZdwTgDIzNZaRBJR601Vj3qoGjP33idRq0d5NfzxGg31GPy6uIISQa0Hi7bWzVxEmEVNidnMmIV50znbWU7Qj0qDbZD1ue8II5pmrqp7/tjM4kG31kM7M0W1VNCfnS+yE7WCNDQ3HuMSVZwzIjfMTI941kZzikhkwhiFaPcR7u+Znwr5DfwfvZOrwL06Yn4ay/Uf+gNd+kggZlT3pQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/9b391844dfbf4a550aed8926c740d642/a59e9/image-22.webp 192w,\n/static/9b391844dfbf4a550aed8926c740d642/0ca9f/image-22.webp 384w,\n/static/9b391844dfbf4a550aed8926c740d642/dc9b9/image-22.webp 768w,\n/static/9b391844dfbf4a550aed8926c740d642/e2c2f/image-22.webp 1152w,\n/static/9b391844dfbf4a550aed8926c740d642/18683/image-22.webp 1155w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/9b391844dfbf4a550aed8926c740d642/3b721/image-22.png 192w,\n/static/9b391844dfbf4a550aed8926c740d642/66595/image-22.png 384w,\n/static/9b391844dfbf4a550aed8926c740d642/fe486/image-22.png 768w,\n/static/9b391844dfbf4a550aed8926c740d642/d2d74/image-22.png 1152w,\n/static/9b391844dfbf4a550aed8926c740d642/7b4c0/image-22.png 1155w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/9b391844dfbf4a550aed8926c740d642/fe486/image-22.png\"\n            alt=\"Alt text\"\n            title=\"Alt text\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h1 id=\"bucket-aggregations\" style=\"position:relative;\">Bucket Aggregations<a href=\"#bucket-aggregations\" aria-label=\"bucket aggregations permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<blockquote>\n<p>Index 내의 doc를 특정 Bucket으로 묶은 다음, 그 버킷내에서의 집계 결과 계산 후 반환</p>\n</blockquote>\n<ul>\n<li>ES 버킷 : <a href=\"https://esbook.kimjmin.net/08-aggregations/8.2-bucket-aggregations\" target=\"_blank\" rel=\"nofollow\">https://esbook.kimjmin.net/08-aggregations/8.2-bucket-aggregations</a></li>\n</ul>\n<p>SpringBoot 내의 검색 Service 단을 다음과 같이 구성해줬다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">public List<span class=\"token operator\">&lt;</span>TableSearchDto<span class=\"token operator\">></span> getTotalTableSearchResult<span class=\"token punctuation\">(</span>String keyword<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        // 빈 키워드인지 체크\n        validateBlankKeyword<span class=\"token punctuation\">(</span>keyword<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        ElasticUtil client <span class=\"token operator\">=</span> ElasticUtil.getInstance<span class=\"token punctuation\">(</span><span class=\"token string\">\"localhost\"</span>, <span class=\"token number\">9200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        // index <span class=\"token builtin class-name\">:</span> tb_table_meta_info-YYYY-MM-DD\n        LocalDate now <span class=\"token operator\">=</span> LocalDate.now<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        // fields\n        List<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> fields <span class=\"token operator\">=</span> new ArrayList<span class=\"token operator\">&lt;></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        fields.add<span class=\"token punctuation\">(</span><span class=\"token string\">\"table_id\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        fields.add<span class=\"token punctuation\">(</span><span class=\"token string\">\"table_comment\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        fields.add<span class=\"token punctuation\">(</span><span class=\"token string\">\"small_clsf_name\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        String indexName <span class=\"token operator\">=</span> <span class=\"token string\">\"tb_table_meta_info-\"</span> + now<span class=\"token punctuation\">;</span>\n        List<span class=\"token operator\">&lt;</span>Map<span class=\"token operator\">&lt;</span>String, Object<span class=\"token operator\">>></span> searchResult <span class=\"token operator\">=</span> client.getTotalTableSearch<span class=\"token punctuation\">(</span>indexName, keyword, fields, <span class=\"token number\">10000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        log.info<span class=\"token punctuation\">(</span><span class=\"token string\">\"{} {}\"</span>, keyValue<span class=\"token punctuation\">(</span><span class=\"token string\">\"requestURI\"</span>, <span class=\"token string\">\"/metadata/search/total\"</span><span class=\"token punctuation\">)</span>, keyValue<span class=\"token punctuation\">(</span><span class=\"token string\">\"keyword\"</span>, keyword<span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span>\n\n        // 검색 결과 -<span class=\"token operator\">></span> TableSearchDto로 감싸주는 작업\n        <span class=\"token builtin class-name\">return</span> searchResult.stream<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                .map<span class=\"token punctuation\">(</span>mapData -<span class=\"token operator\">></span> new TableSearchDto<span class=\"token punctuation\">(</span>String.valueOf<span class=\"token punctuation\">(</span>mapData.get<span class=\"token punctuation\">(</span><span class=\"token string\">\"table_id\"</span><span class=\"token punctuation\">))</span>, String.valueOf<span class=\"token punctuation\">(</span>mapData.get<span class=\"token punctuation\">(</span><span class=\"token string\">\"table_comment\"</span><span class=\"token punctuation\">))</span>, String.valueOf<span class=\"token punctuation\">(</span>mapData.get<span class=\"token punctuation\">(</span><span class=\"token string\">\"small_clsf_name\"</span><span class=\"token punctuation\">))</span>, searchResult.size<span class=\"token punctuation\">(</span><span class=\"token punctuation\">))</span><span class=\"token punctuation\">)</span>\n                .collect<span class=\"token punctuation\">(</span>Collectors.toList<span class=\"token punctuation\">(</span><span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>로그 전송 시, <code class=\"language-text\">StructuredArguments</code> 를 사용하였다.</p>\n<p>requestURI 와 검색 키워드 값(keyword) 을 <code class=\"language-text\">keyvalue</code> 함수를 통해 JSON 형태로 전송하였다. 이를 <code class=\"language-text\">BucketAggregation</code> 을 통해 키워드 기준으로 로그 수를 집계해줬다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">POST logstash-searchlog-2023-09-13/_search\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"query\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"bool\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"must\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">\"match\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"requestURI\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"/metadata/search/total\"</span>\n          <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">\"range\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"time\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span> \n              <span class=\"token string\">\"gte\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2023-09-13T09:55:00\"</span>,\n              <span class=\"token string\">\"lte\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2023-09-13T18:30:00\"</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>,\n  <span class=\"token string\">\"aggs\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"KEYWORD_RANK\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"terms\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"field\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"keyword.keyword\"</span>,\n        <span class=\"token string\">\"size\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">10</span>,\n        <span class=\"token string\">\"min_doc_count\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,\n        <span class=\"token string\">\"shard_min_doc_count\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,\n        <span class=\"token string\">\"show_term_doc_count_error\"</span><span class=\"token builtin class-name\">:</span> false,\n        <span class=\"token string\">\"order\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n          <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"_count\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"desc\"</span>\n          <span class=\"token punctuation\">}</span>,\n          <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"_key\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"asc\"</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>, \n  <span class=\"token string\">\"fields\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"time\"</span>,\n    <span class=\"token string\">\"keyword\"</span>,\n    <span class=\"token string\">\"requestURI\"</span>\n  <span class=\"token punctuation\">]</span>,\n  <span class=\"token string\">\"_source\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>\n<p><code class=\"language-text\">match</code> : 검색 API 요청에 해당하는 로그만 활용</p>\n</li>\n<li>\n<p><code class=\"language-text\">range</code> : 로그 시간대인 time 필드를 활용하여 특정 시간대의 로그만 추출</p>\n</li>\n<li>\n<p><code class=\"language-text\">aggs</code> : 검색 키워드인 keyword 를 기준으로 집계한 Bucket Aggregation 결과 요청</p>\n</li>\n<li>\n<p><code class=\"language-text\">terms</code> : keyword 필드의 문자열 별로 버킷을 나누어 집계가 가능하다. text 필드는 일반적으로 사용 불가능</p>\n</li>\n<li>\n<p><code class=\"language-text\">order</code> : 집계 결과의 정렬 순서를 정의해주는 옵션 (_count: 집계 수, _key: 해당 집계 결과의 key 값)</p>\n</li>\n<li>\n<p><code class=\"language-text\">fields</code> : 검색어 순위에 필요한 결과값인 time, keyword, 그리고 requestURI 를 각각 배열 형태로 받아온다.</p>\n</li>\n</ul>\n<p>위의 요청의 결과값은 다음과 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"took\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,\n  <span class=\"token string\">\"timed_out\"</span> <span class=\"token builtin class-name\">:</span> false,\n  <span class=\"token string\">\"_shards\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"total\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,\n    <span class=\"token string\">\"successful\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,\n    <span class=\"token string\">\"skipped\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,\n    <span class=\"token string\">\"failed\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>\n  <span class=\"token punctuation\">}</span>,\n  <span class=\"token string\">\"hits\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"total\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"value\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">73</span>,\n      <span class=\"token string\">\"relation\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"eq\"</span>\n    <span class=\"token punctuation\">}</span>,\n    <span class=\"token string\">\"max_score\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1.0279663</span>,\n    <span class=\"token string\">\"hits\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"_index\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"logstash-searchlog-2023-09-13\"</span>,\n        <span class=\"token string\">\"_type\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"_doc\"</span>,\n        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"YJ5ujIoBLnJOv6dQmmUa\"</span>,\n        <span class=\"token string\">\"_score\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1.0279663</span>,\n        <span class=\"token string\">\"fields\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">\"time\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"2023-09-13T11:46:13.000Z\"</span>\n          <span class=\"token punctuation\">]</span>,\n          <span class=\"token string\">\"requestURI\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"/metadata/search/total\"</span>\n          <span class=\"token punctuation\">]</span>,\n          <span class=\"token string\">\"keyword\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"심리\"</span>\n          <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>,\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"_index\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"logstash-searchlog-2023-09-13\"</span>,\n        <span class=\"token string\">\"_type\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"_doc\"</span>,\n        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"YZ5ujIoBLnJOv6dQnGV2\"</span>,\n        <span class=\"token string\">\"_score\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1.0279663</span>,\n        <span class=\"token string\">\"fields\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">\"time\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"2023-09-13T11:46:13.000Z\"</span>\n          <span class=\"token punctuation\">]</span>,\n          <span class=\"token string\">\"requestURI\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"/metadata/search/total\"</span>\n          <span class=\"token punctuation\">]</span>,\n          <span class=\"token string\">\"keyword\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"심리\"</span>\n          <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>,\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"_index\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"logstash-searchlog-2023-09-13\"</span>,\n        <span class=\"token string\">\"_type\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"_doc\"</span>,\n        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Yp5ujIoBLnJOv6dQnmXU\"</span>,\n        <span class=\"token string\">\"_score\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1.0279663</span>,\n        <span class=\"token string\">\"fields\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">\"time\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"2023-09-13T11:46:14.000Z\"</span>\n          <span class=\"token punctuation\">]</span>,\n          <span class=\"token string\">\"requestURI\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"/metadata/search/total\"</span>\n          <span class=\"token punctuation\">]</span>,\n          <span class=\"token string\">\"keyword\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"심리\"</span>\n          <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>,\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"_index\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"logstash-searchlog-2023-09-13\"</span>,\n        <span class=\"token string\">\"_type\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"_doc\"</span>,\n        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Y55ujIoBLnJOv6dQoGXl\"</span>,\n        <span class=\"token string\">\"_score\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1.0279663</span>,\n        <span class=\"token string\">\"fields\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">\"time\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"2023-09-13T11:46:14.000Z\"</span>\n          <span class=\"token punctuation\">]</span>,\n          <span class=\"token string\">\"requestURI\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"/metadata/search/total\"</span>\n          <span class=\"token punctuation\">]</span>,\n          <span class=\"token string\">\"keyword\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"심리\"</span>\n          <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>,\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"_index\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"logstash-searchlog-2023-09-13\"</span>,\n        <span class=\"token string\">\"_type\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"_doc\"</span>,\n        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"up7SjIoBLnJOv6dQ8GXU\"</span>,\n        <span class=\"token string\">\"_score\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1.0279663</span>,\n        <span class=\"token string\">\"fields\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">\"time\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"2023-09-13T13:35:48.000Z\"</span>\n          <span class=\"token punctuation\">]</span>,\n          <span class=\"token string\">\"requestURI\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"/metadata/search/total\"</span>\n          <span class=\"token punctuation\">]</span>,\n          <span class=\"token string\">\"keyword\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"문제\"</span>\n          <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>,\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"_index\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"logstash-searchlog-2023-09-13\"</span>,\n        <span class=\"token string\">\"_type\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"_doc\"</span>,\n        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"u57SjIoBLnJOv6dQ82Wy\"</span>,\n        <span class=\"token string\">\"_score\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1.0279663</span>,\n        <span class=\"token string\">\"fields\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">\"time\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"2023-09-13T13:35:49.000Z\"</span>\n          <span class=\"token punctuation\">]</span>,\n          <span class=\"token string\">\"requestURI\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"/metadata/search/total\"</span>\n          <span class=\"token punctuation\">]</span>,\n          <span class=\"token string\">\"keyword\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"문제\"</span>\n          <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>,\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"_index\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"logstash-searchlog-2023-09-13\"</span>,\n        <span class=\"token string\">\"_type\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"_doc\"</span>,\n        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"vJ7SjIoBLnJOv6dQ9WXE\"</span>,\n        <span class=\"token string\">\"_score\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1.0279663</span>,\n        <span class=\"token string\">\"fields\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">\"time\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"2023-09-13T13:35:50.000Z\"</span>\n          <span class=\"token punctuation\">]</span>,\n          <span class=\"token string\">\"requestURI\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"/metadata/search/total\"</span>\n          <span class=\"token punctuation\">]</span>,\n          <span class=\"token string\">\"keyword\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"문제\"</span>\n          <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>,\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"_index\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"logstash-searchlog-2023-09-13\"</span>,\n        <span class=\"token string\">\"_type\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"_doc\"</span>,\n        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"vZ7SjIoBLnJOv6dQ92XD\"</span>,\n        <span class=\"token string\">\"_score\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1.0279663</span>,\n        <span class=\"token string\">\"fields\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">\"time\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"2023-09-13T13:35:50.000Z\"</span>\n          <span class=\"token punctuation\">]</span>,\n          <span class=\"token string\">\"requestURI\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"/metadata/search/total\"</span>\n          <span class=\"token punctuation\">]</span>,\n          <span class=\"token string\">\"keyword\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"문제\"</span>\n          <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>,\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"_index\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"logstash-searchlog-2023-09-13\"</span>,\n        <span class=\"token string\">\"_type\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"_doc\"</span>,\n        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"vp7SjIoBLnJOv6dQ-WU4\"</span>,\n        <span class=\"token string\">\"_score\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1.0279663</span>,\n        <span class=\"token string\">\"fields\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">\"time\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"2023-09-13T13:35:51.000Z\"</span>\n          <span class=\"token punctuation\">]</span>,\n          <span class=\"token string\">\"requestURI\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"/metadata/search/total\"</span>\n          <span class=\"token punctuation\">]</span>,\n          <span class=\"token string\">\"keyword\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"문제\"</span>\n          <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>,\n  <span class=\"token string\">\"aggregations\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"KEYWORD_RANK\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"doc_count_error_upper_bound\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,\n      <span class=\"token string\">\"sum_other_doc_count\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">4</span>,\n      <span class=\"token string\">\"buckets\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">\"key\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"상담\"</span>,\n          <span class=\"token string\">\"doc_count\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">16</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">\"key\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"수학\"</span>,\n          <span class=\"token string\">\"doc_count\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">11</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">\"key\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"문제\"</span>,\n          <span class=\"token string\">\"doc_count\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">9</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">\"key\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>,\n          <span class=\"token string\">\"doc_count\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">7</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">\"key\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"심리\"</span>,\n          <span class=\"token string\">\"doc_count\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">7</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">\"key\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"진단\"</span>,\n          <span class=\"token string\">\"doc_count\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">7</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">\"key\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"영어\"</span>,\n          <span class=\"token string\">\"doc_count\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">4</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">\"key\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"와우\"</span>,\n          <span class=\"token string\">\"doc_count\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">4</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">\"key\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"국어\"</span>,\n          <span class=\"token string\">\"doc_count\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">\"key\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"금융\"</span>,\n          <span class=\"token string\">\"doc_count\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이제 위의 요청과 응답을 Java 프로젝트 내에서 어떤식으로 구현하는지 살펴보자.</p>\n<h1 id=\"high-level-rest-client\" style=\"position:relative;\">High Level Rest Client<a href=\"#high-level-rest-client\" aria-label=\"high level rest client permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<ul>\n<li>Java에서 ES 사용 : <a href=\"https://shanepark.tistory.com/141\" target=\"_blank\" rel=\"nofollow\">https://shanepark.tistory.com/141</a></li>\n<li>Java High Level Rest Client : <a href=\"https://joyhong.tistory.com/107\" target=\"_blank\" rel=\"nofollow\">https://joyhong.tistory.com/107</a></li>\n<li>엘라스틱서치 클라이언트 : <a href=\"https://hanseom.tistory.com/156\" target=\"_blank\" rel=\"nofollow\">https://hanseom.tistory.com/156</a></li>\n</ul>\n<h2 id=\"공통-사항---elasticutiljava\" style=\"position:relative;\">공통 사항 - ElasticUtil.java<a href=\"#%EA%B3%B5%ED%86%B5-%EC%82%AC%ED%95%AD---elasticutiljava\" aria-label=\"공통 사항   elasticutiljava permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>자바 프로젝트 내에서 필요한 API는 2가지이다. <code class=\"language-text\">메타 데이터 전체 기준 검색</code>, 그리고 <code class=\"language-text\">실시간 검색어 순위 결과</code> API이다.<br>\n둘 다 <code class=\"language-text\">ElasticSearch Client</code>가 필요하므로, 자바 내에서 ES 용 클라이언트 생성을 도와주는 <code class=\"language-text\">High Level Rest Client</code> 를 <code class=\"language-text\">ElasticUtil 클래스</code>내에 생성</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">@Component\n@AllArgsConstructor\n@NoArgsConstructor<span class=\"token punctuation\">(</span>access <span class=\"token operator\">=</span> AccessLevel.PROTECTED<span class=\"token punctuation\">)</span>\npublic class ElasticUtil <span class=\"token punctuation\">{</span>\n\n    private static ElasticUtil self<span class=\"token punctuation\">;</span>\n    private RestClientBuilder restClientBuilder<span class=\"token punctuation\">;</span>\n\n    public ElasticUtil<span class=\"token punctuation\">(</span>String hostname, int port<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        HttpHost <span class=\"token function\">host</span> <span class=\"token operator\">=</span> new HttpHost<span class=\"token punctuation\">(</span>hostname, port<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        restClientBuilder <span class=\"token operator\">=</span> RestClient.builder<span class=\"token punctuation\">(</span>host<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    public static ElasticUtil getInstance<span class=\"token punctuation\">(</span>String hostname, int port<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>self <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span>\n            self <span class=\"token operator\">=</span> new ElasticUtil<span class=\"token punctuation\">(</span>hostname, port<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin class-name\">return</span> self<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ES 로 Rest 요청을 보낼 수 있는 Client 인스턴스를 생성해주는 Util 클래스</p>\n<h2 id=\"메타-데이터-전체-기준-검색-api\" style=\"position:relative;\">메타 데이터 전체 기준 검색 API<a href=\"#%EB%A9%94%ED%83%80-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EC%A0%84%EC%B2%B4-%EA%B8%B0%EC%A4%80-%EA%B2%80%EC%83%89-api\" aria-label=\"메타 데이터 전체 기준 검색 api permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">POST tb_table_meta_info-2023-09-12/_search\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"query\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"bool\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"must\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token string\">\"multi_match\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token string\">\"query\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"진단\"</span>,\n                <span class=\"token string\">\"fields\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"table_id\"</span>, <span class=\"token string\">\"table_comment\"</span>, <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token punctuation\">]</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>필요한 QueryDSL 요청문이다. <code class=\"language-text\">multi_match</code> 옵션을 위해, QueryBuilders의 <code class=\"language-text\">multiMatchQuery</code> 함수 사용</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Map</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getTotalTableSearch</span><span class=\"token punctuation\">(</span>\n            <span class=\"token class-name\">String</span> index<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> query<span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> fields<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span> size\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token class-name\">SearchRequest</span> searchRequest <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SearchRequest</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">SearchSourceBuilder</span> searchSourceBuilder <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SearchSourceBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// multi-match query</span>\n        searchSourceBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">QueryBuilders</span><span class=\"token punctuation\">.</span><span class=\"token function\">multiMatchQuery</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">,</span> fields<span class=\"token punctuation\">.</span><span class=\"token function\">toArray</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span>fields<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// set size</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>size <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            searchSourceBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        searchRequest<span class=\"token punctuation\">.</span><span class=\"token function\">source</span><span class=\"token punctuation\">(</span>searchSourceBuilder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Map</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> list <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">RestHighLevelClient</span> client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RestHighLevelClient</span><span class=\"token punctuation\">(</span>restClientBuilder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">SearchResponse</span> response <span class=\"token operator\">=</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">search</span><span class=\"token punctuation\">(</span>searchRequest<span class=\"token punctuation\">,</span> <span class=\"token class-name\">RequestOptions</span><span class=\"token punctuation\">.</span>DEFAULT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">SearchHits</span> searchHits <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">getHits</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">SearchHit</span> hit <span class=\"token operator\">:</span> searchHits<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> sourceMap <span class=\"token operator\">=</span> hit<span class=\"token punctuation\">.</span><span class=\"token function\">getSourceAsMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                list<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>sourceMap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IOException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">return</span> list<span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>함수의 파라미터 값으로 <code class=\"language-text\">index</code> , <code class=\"language-text\">query</code>, <code class=\"language-text\">fields</code>, 그리고 <code class=\"language-text\">size</code> 값을 넘겨줬다.</p>\n<p><code class=\"language-text\">query</code>는 검색 키워드 값, <code class=\"language-text\">fields</code> 는 table_id, table_comment, small_clsf_name이다.</p>\n<p>위의 함수는 <code class=\"language-text\">ElasticUtil 클래스</code>에 저장을 해줬고, 이를 필요로 하는 서비스단에서 사용하기로 함<br>\n다음 경로로 요청이 올 시,</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">// 메타 테이블 전체 검색 API\n<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>host<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>/metadata/search/total?keyword<span class=\"token operator\">=</span><span class=\"token string\">\"검색어\"</span></code></pre></div>\n<p><code class=\"language-text\">MetaDataService</code> 단에서 ES Client의 list 결과를 DTO로 감싸서 최종 리턴해줬다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TableSearchDto</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getTotalTableSearchResult</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> keyword<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token comment\">// 빈 키워드인지 체크</span>\n        <span class=\"token function\">validateBlankKeyword</span><span class=\"token punctuation\">(</span>keyword<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">ElasticUtil</span> client <span class=\"token operator\">=</span> <span class=\"token class-name\">ElasticUtil</span><span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// index : tb_table_meta_info-YYYY-MM-DD</span>\n        <span class=\"token class-name\">LocalDate</span> now <span class=\"token operator\">=</span> <span class=\"token class-name\">LocalDate</span><span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// fields</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> fields <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        fields<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"table_id\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        fields<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"table_comment\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        fields<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"small_clsf_name\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">String</span> indexName <span class=\"token operator\">=</span> <span class=\"token string\">\"tb_table_meta_info-\"</span> <span class=\"token operator\">+</span> now<span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Map</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> searchResult <span class=\"token operator\">=</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">getTotalTableSearch</span><span class=\"token punctuation\">(</span>indexName<span class=\"token punctuation\">,</span> keyword<span class=\"token punctuation\">,</span> fields<span class=\"token punctuation\">,</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{} {}\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">keyValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"requestURI\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/metadata/search/total\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">keyValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"keyword\"</span><span class=\"token punctuation\">,</span> keyword<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 검색 결과 -> TableSearchDto로 감싸주는 작업</span>\n        <span class=\"token keyword\">return</span> searchResult<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>mapData <span class=\"token operator\">-></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TableSearchDto</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">valueOf</span><span class=\"token punctuation\">(</span>mapData<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"table_id\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">valueOf</span><span class=\"token punctuation\">(</span>mapData<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"table_comment\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">valueOf</span><span class=\"token punctuation\">(</span>mapData<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"small_clsf_name\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> searchResult<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>해당 요청의 결과값은 다음과 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"status\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"SUCCESS\"</span>,\n    <span class=\"token string\">\"message\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"메타 테이블 전체 검색 결과 조회 성공했습니다.\"</span>,\n    <span class=\"token string\">\"data\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"tb_psych_diagnosis\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"심리진단\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"심리 진단\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"tb_study_diagnosis\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"학습진단\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"진단 정보\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"TYPE_CST_BODY\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"학력진단 진단지정보 테이블\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"학력진단\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"tb_study_diagnosis_detail\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"학습진단상세\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"진단 상세 정보\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"TYPE_CST_INFO\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"진단정보테이블\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"진단 정보\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"TYPE_CST_CTR_MEMO\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"성격 진단 상담 테이블\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"기록\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"TYPE_CST_CTR_PROBLEM\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"유형진단 문제 정보\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"유형진단\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"TYPE_CST_CTR_RESULT_MASTER\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"유형진단 결과 마스터\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"유형진단\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"TYPE_CST_CTR_RESULT_V2\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"유형진단 테스트 결과\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"유형진단\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"TYPE_CST_STRATEGY_INFO\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"유형진단 월별 전략\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"유형진단\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"AD_STEPENG_TEST_RESULT\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"수준별영어 진단결과[하누리텐 20081201]\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"진단 결과\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"AD_STEPHJ_TEST_RESULT\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"급수한자_진달결과[하누리텐 20081201]\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"진단 결과\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"MT_SUM_LEVEL_TEST_AREA\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"수학 학년별 가입진단 영역별 누적집계(백인흠/생성일:2010-09-13)\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"진단 집계\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"PARENTS_TYPE_MASTER\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"학부모유형마스터\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"유형 진단\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"TYPE_CST_CTR_LEARN\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"유형진단 차시 정보정보\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"유형진단\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"TYPE_CST_CTR_PBL\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"성격진단 문제 정보지 테이블\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"성격진단\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"TAB_TYPE_EXAMINATION_ANSWER\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"부모양육/자녀학습 유형진단 결과 / 생성일 : 2018-11-23\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"진단 결과\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"EVENT_HANJA_LEVEL_CHALLENGE2\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"한자 진단 모의고사 도전 결과\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"도전 결과\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"TB_DGNSS_CNTNTS\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"진단 콘텐츠 관리를 위한 테이블\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"컨텐츠\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"TB_DGNSS_HABIT\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"진단 습관 관리를 위한 테이블\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"습관\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"TB_DGNSS_RESULT\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"진단 결과 관리를 위한 테이블\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"결과\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"TB_DGNSS_SCRIPT\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"진단 스크립트 관리를 위한 테이블\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"스크립트\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"TYPE_CST_AGAIN\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"진단다시풀기 관리(20051105 김인현)\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"다시풀기 관리\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"MT_LEVEL_TEST_START_CHAPTER\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"(2010-06-28 김인현) 진단 평가 학년별 월별 기본 시작 단원, 진단 시작에서 단원선택 안함 이 내용으로 설정, 가입/정기 진단 동일\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"시작 단원\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"TB_DGNSS_ASIGN_MEM\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"진단 배정 회원 관리를 위한 테이블\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"회원\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"TB_DGNSS_CNTNTS_QESITM\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"진단 콘텐츠 문항 관리를 위한 테이블\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"컨텐츠\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"TB_DGNSS_DRCTS\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"진단 지시문 관리를 위한 테이블\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"지시문\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"TB_DGNSS_QESITM_RSPNS\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"진단 문항 응답 관리를 위한 테이블\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"문항 응답\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"TB_DGNSS_STATS\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"진단평가평균관리를 위한 테이블\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"집계\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"TYPE_APTITUDE_TEST_POP\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"진단test 결과체크(2010-03-23 박효정)\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"결과\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"TB_DGNSS_RESULT_REPRT\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"진단 결과 보고서 관리를 위한 테이블\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"결과\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"table_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"TYPE_STUDY_RST_FOR_TBL\"</span>,\n            <span class=\"token string\">\"table_comment\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"학력진단 결과를 시간표와 연결하는 테이블\"</span>,\n            <span class=\"token string\">\"small_clsf_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"결과\"</span>,\n            <span class=\"token string\">\"total_num\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">32</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"실시간-검색어-순위-api\" style=\"position:relative;\">실시간 검색어 순위 API<a href=\"#%EC%8B%A4%EC%8B%9C%EA%B0%84-%EA%B2%80%EC%83%89%EC%96%B4-%EC%88%9C%EC%9C%84-api\" aria-label=\"실시간 검색어 순위 api permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>필요한 QueryDSL 요청값과 이에 대한 응답은 위에 명시가 되어있으니 참고바란다.<br>\n다음 경로로 HTTP GET 요청이 올 시,</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>host<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>/metadata/search/total?keyword<span class=\"token operator\">=</span><span class=\"token string\">\"검색어\"</span></code></pre></div>\n<p>실시간 검색어 순위 결과를 리턴해준다. 우선, 위의 요청에 대한 서비스단과 검색 시 보내지는 로그 형식을 다시 살펴보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TableSearchKeywordRankDto</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getTableSearchRank</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">TableSearchRankRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token comment\">// message 안에 uri 가 포함된 로그만 필터링</span>\n        <span class=\"token class-name\">String</span> uri <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getUri</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 검색 시간대</span>\n        <span class=\"token class-name\">String</span> gte <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getGte</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">String</span> lte <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getLte</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">ElasticUtil</span> client <span class=\"token operator\">=</span> <span class=\"token class-name\">ElasticUtil</span><span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// index : logstash-searchlog-YYYY-MM-DD</span>\n        <span class=\"token class-name\">LocalDate</span> now <span class=\"token operator\">=</span> <span class=\"token class-name\">LocalDate</span><span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">String</span> indexName <span class=\"token operator\">=</span> <span class=\"token string\">\"logstash-searchlog-\"</span> <span class=\"token operator\">+</span> now<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">getTableSearchRank</span><span class=\"token punctuation\">(</span>indexName<span class=\"token punctuation\">,</span> uri<span class=\"token punctuation\">,</span> gte<span class=\"token punctuation\">,</span> lte<span class=\"token punctuation\">,</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{} {}\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">keyValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"requestURI\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/metadata/search/total\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">keyValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"keyword\"</span><span class=\"token punctuation\">,</span> keyword<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>검색 시, requestURI 와 검색 키워드인 keyword 를 keyValue 형식으로 보내줬다.</p>\n<p><code class=\"language-text\">해당 URI 에만 해당되고, 원하는 시간대 값 내의 로그들이 집계된 결과</code> → 궁극적으로 필요한 값</p>\n<p>서비스단에서 RequestBody 내의 <code class=\"language-text\">URI, GTE, LTE</code> 를 받아와 ElasticUtil의 <code class=\"language-text\">getTableSearchRank</code> 함수의 파라미터로 넘겨줬다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TableSearchKeywordRankDto</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getTableSearchRank</span><span class=\"token punctuation\">(</span>\n            <span class=\"token class-name\">String</span> index<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> uri<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> gte<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> lte<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span> logResultSize<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span> rankResultSize\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">SearchRequest</span> searchRequest <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SearchRequest</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">SearchSourceBuilder</span> searchSourceBuilder <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SearchSourceBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// match -> message : URI</span>\n        <span class=\"token class-name\">BoolQueryBuilder</span> boolQuery <span class=\"token operator\">=</span> <span class=\"token class-name\">QueryBuilders</span><span class=\"token punctuation\">.</span><span class=\"token function\">boolQuery</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        boolQuery<span class=\"token punctuation\">.</span><span class=\"token function\">must</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">QueryBuilders</span><span class=\"token punctuation\">.</span><span class=\"token function\">matchQuery</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">,</span> uri<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// range -> gte to lte</span>\n        <span class=\"token class-name\">RangeQueryBuilder</span> rangeQuery <span class=\"token operator\">=</span> <span class=\"token class-name\">QueryBuilders</span><span class=\"token punctuation\">.</span><span class=\"token function\">rangeQuery</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"time\"</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">gte</span><span class=\"token punctuation\">(</span>gte<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">lte</span><span class=\"token punctuation\">(</span>lte<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        boolQuery<span class=\"token punctuation\">.</span><span class=\"token function\">must</span><span class=\"token punctuation\">(</span>rangeQuery<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        searchSourceBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span>boolQuery<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// time, requestURI, keyword 필드만 받아오도록</span>\n        <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> includes <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"time\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"requestURI\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"keyword\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        searchSourceBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">fetchSource</span><span class=\"token punctuation\">(</span>includes<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">TermsAggregationBuilder</span> aggregationBuilder <span class=\"token operator\">=</span> <span class=\"token class-name\">AggregationBuilders</span><span class=\"token punctuation\">.</span><span class=\"token function\">terms</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"KEYWORD_RANK\"</span><span class=\"token punctuation\">)</span>\n                                                                        <span class=\"token punctuation\">.</span><span class=\"token function\">field</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"keyword.keyword\"</span><span class=\"token punctuation\">)</span>\n                                                                        <span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span>rankResultSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        searchSourceBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">aggregation</span><span class=\"token punctuation\">(</span>aggregationBuilder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// set size</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>logResultSize <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            searchSourceBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span>logResultSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        searchRequest<span class=\"token punctuation\">.</span><span class=\"token function\">source</span><span class=\"token punctuation\">(</span>searchSourceBuilder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        searchRequest<span class=\"token punctuation\">.</span><span class=\"token function\">scroll</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">TimeValue</span><span class=\"token punctuation\">.</span><span class=\"token function\">timeValueMinutes</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TableSearchKeywordRankDto</span><span class=\"token punctuation\">></span></span> list <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">RestHighLevelClient</span> client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RestHighLevelClient</span><span class=\"token punctuation\">(</span>restClientBuilder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">SearchResponse</span> response <span class=\"token operator\">=</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">search</span><span class=\"token punctuation\">(</span>searchRequest<span class=\"token punctuation\">,</span> <span class=\"token class-name\">RequestOptions</span><span class=\"token punctuation\">.</span>DEFAULT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token class-name\">RestStatus</span> status <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">==</span> <span class=\"token class-name\">RestStatus</span><span class=\"token punctuation\">.</span>OK<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\">Aggregations</span> aggregations <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">getAggregations</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">Terms</span> keywordAggs <span class=\"token operator\">=</span> aggregations<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"KEYWORD_RANK\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Terms<span class=\"token punctuation\">.</span>Bucket</span> bucket <span class=\"token operator\">:</span> keywordAggs<span class=\"token punctuation\">.</span><span class=\"token function\">getBuckets</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    list<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">TableSearchKeywordRankDto</span><span class=\"token punctuation\">(</span>bucket<span class=\"token punctuation\">.</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> bucket<span class=\"token punctuation\">.</span><span class=\"token function\">getDocCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IOException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">return</span> list<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>\n<p><code class=\"language-text\">boolQuery, matchQuery</code> : 로그 중, 검색 요청 경로에 매칭되는 로그만 사용할 수 있도록 필터링</p>\n</li>\n<li>\n<p><code class=\"language-text\">rangeQuery</code> : 시간대 값 범위 설정에 필요한 함수</p>\n</li>\n<li>\n<p><code class=\"language-text\">AggregationBuilder</code> : QueryDSL의 aggs 에 필요한 요청을 설정해주는 부분</p>\n</li>\n</ul>\n<p>해당 리스트의 결과를 서비스 단이 아닌, ElasticUtil 클래스 내에서 DTO 변환 작업을 수행해줬다. 최종 결과는 다음과 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"status\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"SUCCESS\"</span>,\n    <span class=\"token string\">\"message\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"특정 시간대의 검색어 순위 집계에 성공했습니다.\"</span>,\n    <span class=\"token string\">\"data\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"keyword\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"진단\"</span>,\n            <span class=\"token string\">\"count\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">7</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"keyword\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"EVENT\"</span>,\n            <span class=\"token string\">\"count\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">6</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"keyword\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"영어\"</span>,\n            <span class=\"token string\">\"count\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">5</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"keyword\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"수학\"</span>,\n            <span class=\"token string\">\"count\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">4</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","frontmatter":{"title":"ElasticSearch - 실시간 검색어 순위","summary":"ELK Stack 기반 실시간 검색어 순위 기능 구현","date":"2023.09.11.","categories":["VISANG","ElasticSearch","Logstash","Kibana"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/webp;base64,UklGRiQBAABXRUJQVlA4IBgBAACwBQCdASoUAAsAAAAAJYwAcBnaAEGgxgD8QJ6B/gPsA81X1Kf6N+Rf7/8YAa15HqeysTTwNRAA/v//qlDsT+tv0bcXJhxFv/PxXuJ6PV7ZsiA6cfUcIXo/lxEoo6xIRJPpV29fuflNFqWWCrKpLOT+/7U//RRa/emTf9Xp/+clRGx7tEo8b/uGgYfZJ6+M//Ifzx1MDIvm4n/r3vDz3T/KuzeUQpviKRzHu9f4TJcbALP3vk8OdWO1n//wgSr//8q//i52D/0MP/Ydfznf67c/gM7+ZRzyBXof//MZ/9R/9qI/5VIoP/tz8d45PymvuniUvddr/iiJhM/xQsM4+q9D55Mr1v7zs//xpwx0P+9BIV5UX16tIAAA"},"images":{"fallback":{"src":"/static/187a1da2b4a7a6e4c3345bdefa435c3d/06313/thumbnail-elasticsearch.webp","srcSet":"/static/187a1da2b4a7a6e4c3345bdefa435c3d/06e70/thumbnail-elasticsearch.webp 225w,\n/static/187a1da2b4a7a6e4c3345bdefa435c3d/6ec2c/thumbnail-elasticsearch.webp 450w,\n/static/187a1da2b4a7a6e4c3345bdefa435c3d/06313/thumbnail-elasticsearch.webp 900w","sizes":"(min-width: 900px) 900px, 100vw"},"sources":[]},"width":900,"height":500}},"publicURL":"/static/187a1da2b4a7a6e4c3345bdefa435c3d/thumbnail-elasticsearch.webp"}}}}]}},"pageContext":{"slug":"/ES_실시간_검색어_순위/"}},"staticQueryHashes":[]}