{"componentChunkName":"component---src-templates-post-template-tsx","path":"/pickmydol-트러블슈팅_2/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EB%AC%B8%EC%A0%9C-%EA%B0%9C%EC%9A%94\">문제 개요</a></p>\n<ul>\n<li>\n<p><a href=\"#%EB%AC%B8%EC%A0%9C-1-kafka-%EB%8B%A8%EC%9D%BC-partition%EC%9C%BC%EB%A1%9C-%EC%9D%B8%ED%95%9C-redis-%EB%B3%91%EB%AA%A9\">문제 1: Kafka 단일 Partition으로 인한 Redis 병목</a></p>\n<ul>\n<li><a href=\"#-%EB%AC%B8%EC%A0%9C-%EC%83%81%ED%99%A9\">🔥 문제 상황</a></li>\n<li><a href=\"#-%EC%9B%90%EC%9D%B8\">🧨 원인</a></li>\n<li><a href=\"#-%ED%95%B4%EA%B2%B0-%EB%B0%A9%EB%B2%95\">✅ 해결 방법</a></li>\n<li><a href=\"#-%EA%B2%BD%ED%97%98-%EC%9A%94%EC%95%BD\">📌 경험 요약</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%AC%B8%EC%A0%9C-2-kafka-consumer-%EC%88%98%EC%8B%A0-%EC%8B%A4%ED%8C%A8-advertisedlisteners-%EC%84%A4%EC%A0%95-%EC%98%A4%EB%A5%98\">문제 2: Kafka Consumer 수신 실패 (advertised.listeners 설정 오류)</a></p>\n<ul>\n<li><a href=\"#-%EB%AC%B8%EC%A0%9C-%EC%83%81%ED%99%A9-1\">🔥 문제 상황</a></li>\n<li><a href=\"#-%EC%9B%90%EC%9D%B8-1\">🧨 원인</a></li>\n<li><a href=\"#-%ED%95%B4%EA%B2%B0-%EB%B0%A9%EB%B2%95-1\">✅ 해결 방법</a></li>\n<li><a href=\"#-%EA%B2%BD%ED%97%98-%EC%9A%94%EC%95%BD-1\">📌 경험 요약</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%AC%B8%EC%A0%9C-3-kafka-%EB%8F%99%EA%B8%B0-%EB%B0%A9%EC%8B%9D--%EB%B9%84%EB%8F%99%EA%B8%B0-%EB%B0%A9%EC%8B%9D-%EC%A0%84%ED%99%98\">문제 3. Kafka 동기 방식 → 비동기 방식 전환</a></p>\n<ul>\n<li><a href=\"#-%EB%AC%B8%EC%A0%9C-%EC%83%81%ED%99%A9-2\">🔥 문제 상황</a></li>\n<li><a href=\"#-%ED%95%B4%EA%B2%B0-%EB%B0%A9%EB%B2%95-2\">✅ 해결 방법</a></li>\n<li><a href=\"#-%EC%98%88%EC%8B%9C-%EC%BD%94%EB%93%9C-redis-%EC%A0%80%EC%9E%A5\">🔧 예시 코드 (Redis 저장)</a></li>\n<li><a href=\"#-%EA%B8%B0%EC%88%A0-%EA%B0%9C%EB%85%90-%EC%A0%95%EB%A6%AC\">✅ 기술 개념 정리</a></li>\n<li><a href=\"#-%EC%A3%BC%EC%9A%94-%EC%84%B1%EA%B3%BC\">✅ 주요 성과</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EA%B2%B0%EA%B3%BC-%EB%B0%8F-%ED%9A%8C%EA%B3%A0\">결과 및 회고</a></p>\n<ul>\n<li><a href=\"#-504-gateway-timeout-%EB%8C%80%EC%9D%91-%EA%B2%BD%ED%97%98-%EA%B8%B0%EB%B0%98-%EA%B3%84%ED%9A%8D\">✅ 504 Gateway Timeout 대응 경험 기반 계획</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>","html":"<h1 id=\"문제-개요\" style=\"position:relative;\">문제 개요<a href=\"#%EB%AC%B8%EC%A0%9C-%EA%B0%9C%EC%9A%94\" aria-label=\"문제 개요 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>Kafka 기반 스트리밍 처리 환경에서 Redis 저장 병목과 메시지 수신 실패라는 두 가지 핵심 문제가 발생했다. 시스템은 Kafka → Redis → PostgreSQL 흐름을 기반으로, EC2 인스턴스에 Docker로 구성된 비동기 소비자 구조였다.</p>\n<h2 id=\"문제-1-kafka-단일-partition으로-인한-redis-병목\" style=\"position:relative;\">문제 1: Kafka 단일 Partition으로 인한 Redis 병목<a href=\"#%EB%AC%B8%EC%A0%9C-1-kafka-%EB%8B%A8%EC%9D%BC-partition%EC%9C%BC%EB%A1%9C-%EC%9D%B8%ED%95%9C-redis-%EB%B3%91%EB%AA%A9\" aria-label=\"문제 1 kafka 단일 partition으로 인한 redis 병목 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<h3 id=\"-문제-상황\" style=\"position:relative;\">🔥 문제 상황<a href=\"#-%EB%AC%B8%EC%A0%9C-%EC%83%81%ED%99%A9\" aria-label=\" 문제 상황 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>초기 Kafka Topic이 단일 Partition으로 구성되어 있었고, Consumer 또한 1개만 존재한 구조였다. 이 구조에서는 모든 메시지 처리를 하나의 Consumer가 담당하며, Redis 저장 작업도 병렬로 이루어지지 않아 Redis 병목이 발생했다.</p>\n<h3 id=\"-원인\" style=\"position:relative;\">🧨 원인<a href=\"#-%EC%9B%90%EC%9D%B8\" aria-label=\" 원인 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Kafka는 Partition 수에 따라 메시지가 Consumer에 분산된다. 하지만 단일 Partition → 단일 Consumer 구조에서는 수평 확장이 불가능했고, **burst 트래픽(300,000 수준)**을 감당하지 못하는 병목점이 되었다.</p>\n<h3 id=\"-해결-방법\" style=\"position:relative;\">✅ 해결 방법<a href=\"#-%ED%95%B4%EA%B2%B0-%EB%B0%A9%EB%B2%95\" aria-label=\" 해결 방법 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Kafka Topic을 300개 Partition으로 확장</p>\n<p>동일한 group.id를 가진 Consumer 컨테이너를 여러 EC2 인스턴스에 분산 배포</p>\n<p>Kafka의 Partition-to-Consumer Mapping 구조를 활용하여 Redis 저장 작업을 병렬 분산</p>\n<h3 id=\"-경험-요약\" style=\"position:relative;\">📌 경험 요약<a href=\"#-%EA%B2%BD%ED%97%98-%EC%9A%94%EC%95%BD\" aria-label=\" 경험 요약 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>이 경험은 Kafka 구조에 대한 실전 이해를 바탕으로, 병목 지점 분석 → 구조 재설계를 통해 Burst 트래픽 처리용 아키텍처를 완성한 사례였다.</p>\n<h2 id=\"문제-2-kafka-consumer-수신-실패-advertisedlisteners-설정-오류\" style=\"position:relative;\">문제 2: Kafka Consumer 수신 실패 (advertised.listeners 설정 오류)<a href=\"#%EB%AC%B8%EC%A0%9C-2-kafka-consumer-%EC%88%98%EC%8B%A0-%EC%8B%A4%ED%8C%A8-advertisedlisteners-%EC%84%A4%EC%A0%95-%EC%98%A4%EB%A5%98\" aria-label=\"문제 2 kafka consumer 수신 실패 advertisedlisteners 설정 오류 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<h3 id=\"-문제-상황-1\" style=\"position:relative;\">🔥 문제 상황<a href=\"#-%EB%AC%B8%EC%A0%9C-%EC%83%81%ED%99%A9-1\" aria-label=\" 문제 상황 1 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Kafka Consumer가 메시지를 수신하지 못하고 타임아웃이 지속 발생.</p>\n<h3 id=\"-원인-1\" style=\"position:relative;\">🧨 원인<a href=\"#-%EC%9B%90%EC%9D%B8-1\" aria-label=\" 원인 1 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Kafka server.properties 파일의 advertised.listeners 값이 localhost:9092로 고정되어 있었고, 외부에서 접속하는 EC2 기반 Consumer는 Private IP를 경유해 접근해야 했음.\n→ Broker가 자신의 주소를 잘못 알려주는 구조였고, DNS 및 NAT 문제와 연결되어 통신이 실패함.</p>\n<h3 id=\"-해결-방법-1\" style=\"position:relative;\">✅ 해결 방법<a href=\"#-%ED%95%B4%EA%B2%B0-%EB%B0%A9%EB%B2%95-1\" aria-label=\" 해결 방법 1 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>EC2 내 메타데이터에서 실제 Private IP를 동적으로 추출</p>\n<p>advertised.listeners 값을 ${EC2_IP}:9092 형식으로 자동 주입하는 Shell Script 작성</p>\n<p>Kafka를 재시작하여 Broker 주소를 올바르게 인식시킴</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">EC2_IP</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> -s http://169.254.169.254/latest/meta-data/local-ipv4<span class=\"token variable\">)</span></span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"advertised.listeners=PLAINTEXT://<span class=\"token variable\">${EC2_IP}</span>:9092\"</span> <span class=\"token operator\">>></span> /opt/kafka/config/server.properties\nsystemctl restart kafka</code></pre></div>\n<p>Kafka Consumer가 정상적으로 메시지를 수신함을 로그에서 확인했고, 안정적인 트래픽 수신이 가능해졌다.</p>\n<h3 id=\"-경험-요약-1\" style=\"position:relative;\">📌 경험 요약<a href=\"#-%EA%B2%BD%ED%97%98-%EC%9A%94%EC%95%BD-1\" aria-label=\" 경험 요약 1 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>이 과정에서 Kafka 네트워크 구조와 EC2 내 메타데이터 활용, 동적 설정 주입 자동화에 대한 경험을 쌓았고, 클라우드 환경에서의 Kafka 운영 실무 감각을 체득할 수 있었다.</p>\n<h2 id=\"문제-3-kafka-동기-방식--비동기-방식-전환\" style=\"position:relative;\">문제 3. Kafka 동기 방식 → 비동기 방식 전환<a href=\"#%EB%AC%B8%EC%A0%9C-3-kafka-%EB%8F%99%EA%B8%B0-%EB%B0%A9%EC%8B%9D--%EB%B9%84%EB%8F%99%EA%B8%B0-%EB%B0%A9%EC%8B%9D-%EC%A0%84%ED%99%98\" aria-label=\"문제 3 kafka 동기 방식  비동기 방식 전환 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<h3 id=\"-문제-상황-2\" style=\"position:relative;\">🔥 문제 상황<a href=\"#-%EB%AC%B8%EC%A0%9C-%EC%83%81%ED%99%A9-2\" aria-label=\" 문제 상황 2 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>기존에는 @KafkaListener 기반 동기 방식으로 Kafka 메시지를 수신하고, 각 메시지를 Redis에 저장</p>\n<p>300,000 수준의 버스트 트래픽 처리 시 병목 발생</p>\n<p>Consumer 한 대가 모든 부하를 감당</p>\n<p>처리량, 타임아웃, 실패 대응 한계</p>\n<h3 id=\"-해결-방법-2\" style=\"position:relative;\">✅ 해결 방법<a href=\"#-%ED%95%B4%EA%B2%B0-%EB%B0%A9%EB%B2%95-2\" aria-label=\" 해결 방법 2 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>💡 비동기 방식 도입\nReactor Kafka 기반의 KafkaReceiver 도입</p>\n<p>메시지를 Flux 스트림으로 수신하여 .flatMap()으로 Redis 저장 처리</p>\n<p>.timeout(), .subscribeOn(), .onErrorResume() 등을 활용해 다음을 구현:</p>\n<p>타임아웃 처리</p>\n<p>컨슈머 실패 시 fallback 처리</p>\n<p>병렬 실행 제어</p>\n<h3 id=\"-예시-코드-redis-저장\" style=\"position:relative;\">🔧 예시 코드 (Redis 저장)<a href=\"#-%EC%98%88%EC%8B%9C-%EC%BD%94%EB%93%9C-redis-%EC%A0%80%EC%9E%A5\" aria-label=\" 예시 코드 redis 저장 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">Mono</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">createVoteWithRedis</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">String</span> redisKey <span class=\"token operator\">=</span> <span class=\"token string\">\"vote:\"</span> <span class=\"token operator\">+</span> name<span class=\"token punctuation\">;</span>\n    log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"📌 Redis Increment 요청 Key: {}\"</span><span class=\"token punctuation\">,</span> redisKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">hasKey</span><span class=\"token punctuation\">(</span>redisKey<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">flatMap</span><span class=\"token punctuation\">(</span>exists <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>exists <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> exists<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">return</span> redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">opsForValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">increment</span><span class=\"token punctuation\">(</span>redisKey<span class=\"token punctuation\">)</span>\n                            <span class=\"token punctuation\">.</span><span class=\"token function\">doOnNext</span><span class=\"token punctuation\">(</span>count <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"🔁 Redis Increment: {} -> {}\"</span><span class=\"token punctuation\">,</span> redisKey<span class=\"token punctuation\">,</span> count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                            <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Mono&lt;Void></span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">return</span> redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">opsForValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">increment</span><span class=\"token punctuation\">(</span>redisKey<span class=\"token punctuation\">)</span>\n                            <span class=\"token punctuation\">.</span><span class=\"token function\">doOnNext</span><span class=\"token punctuation\">(</span>count <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"🆕 Redis Increment + TTL 설정: {} -> {}\"</span><span class=\"token punctuation\">,</span> redisKey<span class=\"token punctuation\">,</span> count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                            <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">expire</span><span class=\"token punctuation\">(</span>redisKey<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Duration</span><span class=\"token punctuation\">.</span><span class=\"token function\">ofHours</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"-기술-개념-정리\" style=\"position:relative;\">✅ 기술 개념 정리<a href=\"#-%EA%B8%B0%EC%88%A0-%EA%B0%9C%EB%85%90-%EC%A0%95%EB%A6%AC\" aria-label=\" 기술 개념 정리 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>🔸 flatMap()과 then()의 차이\n|항목|–|flatMap()|–|then()|<br>\n반환값 사용\t사용함\t사용하지 않음\n목적\t값을 다음 연산으로 전달\t순차 실행만 원할 때\n반환 타입\tMono<R>\tMono<Void> 또는 연결 Mono 타입\n예시\tDB 결과로 분기 처리\t작업 완료 후 로그 출력, TTL 설정 등</p>\n<p>🔸 예시 비교\nflatMap() 사용 시 (값을 활용해야 할 때)\njava\n복사\n편집\n.flatMap(count -> redisTemplate.expire(key, Duration.ofHours(2)))\nthen() 사용 시 (값 무시하고 다음 실행만)\njava\n복사\n편집\n.doOnNext(count -> log.info(”…”))\n.then(redisTemplate.expire(key, Duration.ofHours(2)))</p>\n<h3 id=\"-주요-성과\" style=\"position:relative;\">✅ 주요 성과<a href=\"#-%EC%A3%BC%EC%9A%94-%EC%84%B1%EA%B3%BC\" aria-label=\" 주요 성과 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>300,000 트래픽 수준에서도 안정적인 메시지 처리 가능</p>\n<p>Redis 저장 병목 제거</p>\n<p>Reactive Stream 기반의 처리 흐름을 효과적으로 구성</p>\n<p>트래픽 유실 없이 타임아웃 및 예외 상황 대응 가능</p>\n<h2 id=\"결과-및-회고\" style=\"position:relative;\">결과 및 회고<a href=\"#%EA%B2%B0%EA%B3%BC-%EB%B0%8F-%ED%9A%8C%EA%B3%A0\" aria-label=\"결과 및 회고 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ul>\n<li>\n<p>Kafka 기반 비동기 구조의 성능 병목 원인을 진단하고 Topic 파티셔닝 및 Consumer 병렬 처리 구조로 개선</p>\n</li>\n<li>\n<p>Kafka의 외부 접속 설정 오류를 해결하여, 클라우드 내 자동화된 Broker 설정 구성 구축</p>\n</li>\n<li>\n<p>300,000 트래픽 수용 테스트에서 안정적인 메시지 수신 및 Redis 처리 구조 검증</p>\n</li>\n</ul>\n<p>위의 개선사항을 토대로 서버 7대 기준, <code class=\"language-text\">300,000 버스트 트래픽 중, 약 29만건을 성공적으로 인식한 후 Valkey 캐시에 저장</code>할 수 있었다.</p>\n<iframe src=\"https://drive.google.com/file/d/1T3JBCq7wm_x2vhOhLCXr81ZaluORh19S/preview\" \n        width=\"640\" height=\"360\" allow=\"autoplay\" allowfullscreen>\n</iframe>\n<p>하지만, 나머지 유실된 약 1만건은 아래 ngrinder agent 로그 처럼 504 Timeout Error가 뜬다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">2025</span>-06-11 <span class=\"token number\">18</span>:25:32,252 INFO  http://pickmydol-dev-alb-1687995646.ap-northeast-2.elb.amazonaws.com:81/api/v1/votes -<span class=\"token operator\">></span> <span class=\"token number\">504</span> Gateway Time-out, <span class=\"token number\">132</span> bytes\n<span class=\"token number\">2025</span>-06-11 <span class=\"token number\">18</span>:25:32,252 ERROR ❌ Error: Status <span class=\"token number\">504</span>, Body: <span class=\"token operator\">&lt;</span>html<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>head<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>title<span class=\"token operator\">></span><span class=\"token number\">504</span> Gateway Time-out<span class=\"token operator\">&lt;</span>/title<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>/head<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>body<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>center<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>h<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span><span class=\"token number\">504</span> Gateway Time-out<span class=\"token operator\">&lt;</span>/h<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span><span class=\"token operator\">&lt;</span>/center<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>/body<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>/html<span class=\"token operator\">></span></code></pre></div>\n<p>따라서, 하기 개선사항을 계획하였고 향후 실행할 예정이다.</p>\n<h3 id=\"-504-gateway-timeout-대응-경험-기반-계획\" style=\"position:relative;\">✅ 504 Gateway Timeout 대응 경험 기반 계획<a href=\"#-504-gateway-timeout-%EB%8C%80%EC%9D%91-%EA%B2%BD%ED%97%98-%EA%B8%B0%EB%B0%98-%EA%B3%84%ED%9A%8D\" aria-label=\" 504 gateway timeout 대응 경험 기반 계획 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>실시간 투표 시스템을 개발하면서 처음에는 <code class=\"language-text\">504 Gateway Timeout</code>이 발생했을 때 Spring WebFlux 내부에서의 타임아웃 설정이나 Netty 관련 문제라고 판단했습니다. 하지만 로그를 자세히 분석해보니 실제 원인은 WebFlux 내부가 아니라, <strong>AWS ALB(Application Load Balancer) 단에서 응답 지연으로 인해 504 오류가 발생하고 있었던 것</strong>이었다.</p>\n<p>즉, 서버는 정상적으로 작동하고 있었지만 ALB가 요청에 대 한 응답을 <strong>기한 내에 받지 못해서 오류를 발생시킨 것</strong>이었고, 이 문제는 WebFlux에서 직접 감지할 수 없는 외부 네트워크 계층의 장애였다.</p>\n<p>그래서 아키텍처적으로 접근을 바꾸기로 하였다.<br>\n<strong>WebFlux 단에서의 오류 처리가 아닌, ALB를 거쳐 API를 호출하는 <code class=\"language-text\">nGrinder controller</code> 단에서 HTTP 응답 코드를 감지하고, 504 오류 발생 시에는 별도로 구성한 <code class=\"language-text\">/api/v1/dlq</code> API로 메시지를 분기 전송</strong>하도록 처리 로직을 변경할 예정이다.</p>\n<p>이 <code class=\"language-text\">/dlq</code> API는 Kafka DLQ 토픽에 메시지를 발행하고, DLQConsumer는 실패 데이터를 분석 가능한 형태로 DB에 저장하여 나중에 재처리하거나, 실패 원인을 시각화하고 운영에 활용할 수 있도록 구성할 것 이다.</p>","frontmatter":{"title":"Pickmydol - 30만 버스트 트래픽 환경 구성 트러블 슈팅 #2","summary":"Kafka 관련 트러블 슈팅 정리","date":"2025.06.03.","categories":["Kafka"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAPoAAAD6AG1e1JrAAACaElEQVQozzWS208TURCH953ds7vnnN09e+mWbbu0tS2lXSyXWlAsAQGhoIlNCCBGAkoUJWhsEAUvaCAkpCQgiE1tKy8EAX3hEkN4pv8C/4tpVpPvYTKZZDLz/Si6CtBVgKHZSkHTAHAsy9ud//CAgQhKgqjYOHSXx/QLokKxLM/QLAuQKCj2KIISQ/M2gIGAgTwvYqJKRNMcRiBY5/WHiKIjKFEchxGUPn74VCz+iEQswECMCEaEBchGwLIi60Rzuj2+eDxhVJsCljkOswBRCAoYkcnJJ/s/D1Opga3N7e6u2wKWMSI8LwpYJkQz3N54vDV2tVGRdVFQEJQQlDgOU4QQXdenp2fOzs6KxWI+n19c/ByJWJnMbEMs3p7s6O1NvZmbX13NjoyMWtGG663JhlhcEtXKZtP0+n2Bw8Pfw8P3c7n81NPn6fTg2Nj45eXl2tra+fl5uVw+2P/1detbuVyee/02m82enJwosiYIEuXQDJ83+PLFq9PTP7lcfmtze339Szo9WPheWl5aOT4+vbi42NjYXF5aKRQKy0sre3sHR0dH0Wh9IBD6d/Ojicnd3b2e7lSptJMauOsPhFsSbeFaa2L88bOpmUxmNnHtRnvyVkuiLRqJNTUmgoE60+OnKp5YfmHhfam009zUojkMTNRqV00oFPGY/gejD5M3O+fn3w0NjaiK0+P2OTSDEI0Qze3yUpVgMFCUVNXpQlDieZFHUo3vitMwBVHp6OypjzV39aQymUy41uJ50f4zC1DFM0OzHIdtMbZYBCVRUiEmHIdDYSsUtlSnq//Ovb6+fiTIAHAAcHb4/gIzjJ39iU6iagAAAABJRU5ErkJggg=="},"images":{"fallback":{"src":"/static/851046c5546ee8d83b256de1142584e2/27c85/thumbnail-kafka.webp","srcSet":"/static/851046c5546ee8d83b256de1142584e2/002ed/thumbnail-kafka.webp 250w,\n/static/851046c5546ee8d83b256de1142584e2/d8b92/thumbnail-kafka.webp 500w,\n/static/851046c5546ee8d83b256de1142584e2/27c85/thumbnail-kafka.webp 1000w","sizes":"(min-width: 1000px) 1000px, 100vw"},"sources":[]},"width":1000,"height":563}},"publicURL":"/static/851046c5546ee8d83b256de1142584e2/thumbnail-kafka.png"}}}}]}},"pageContext":{"slug":"/pickmydol-트러블슈팅_2/"}},"staticQueryHashes":[]}